# Phase 4.1: Web Chat (Dev Testing Tool)

**Stage:** Local Development
**Depends on:** Phase 4 (Screenshots) — code complete, blocked on Twilio WhatsApp Sandbox setup
**Done when:** You open the web chat page on your phone's browser, send "show me the app", and receive a screenshot inline.

## Why This Exists

Twilio WhatsApp Sandbox setup can take time. This phase adds a browser-based chat interface so development and testing can continue without waiting for WhatsApp delivery. It's a dev tool, not a product change.

## What You Build

A single HTML page served by the relay server that mimics the WhatsApp conversation. The user opens it on their phone's browser, types messages, and sees responses including images — identical to WhatsApp but bypassing Twilio entirely.

```
WhatsApp (production):  Phone → Twilio → Relay → VM → Relay → Twilio → Phone
Web chat (dev):    Phone Browser → Relay → VM → Relay → Phone Browser
```

**No changes to existing relay or VM code.** The web chat page uses a new `/chat` API endpoint on the relay that calls the same `forwardToVM()` function.

## Deliverables

- `GET /` — serves the web chat HTML page
- `POST /chat` — JSON API endpoint (same as `/sms` flow but no Twilio dependency)
- Chat UI: message input, send button, conversation thread with text + images
- Mobile-friendly (this will primarily be used from a phone browser)
- Works over ngrok (so you can test from your phone on the same Wi-Fi or remotely)

## Technical Approach

### New endpoint: `POST /chat`

```
POST /chat
Content-Type: application/json

{ "text": "show me the app" }
```

Response:
```json
{
  "text": "Here's a screenshot of your running app.",
  "images": ["/images/abc123.jpeg"]
}
```

Internally calls `forwardToVM(text)` — the same function used by the WhatsApp handler. No Twilio auth, no phone allowlist (dev tool only).

### Chat UI

Single HTML file with inline CSS/JS. No build step, no dependencies.

- Text input + send button at bottom (mobile keyboard friendly)
- Messages display in a scrolling thread (user messages right-aligned, bot messages left-aligned)
- Images render inline as `<img>` tags pointing to `/images/:filename`
- Loading spinner while waiting for VM response
- Auto-scroll to latest message

### Security Note

The `/chat` endpoint has no authentication — it's a dev tool for local use only. Do not expose in production without adding auth.

## Tasks

- [ ] Add `POST /chat` endpoint to `server.js` (reuses `forwardToVM`)
- [ ] Add `GET /` route serving the chat HTML page
- [ ] Create chat UI (inline HTML/CSS/JS, mobile-friendly)
- [ ] Test: open on phone browser via ngrok, send "show me the app", see screenshot inline

## Acceptance Criteria

- [ ] Opening the relay URL in a phone browser shows the chat interface
- [ ] Sending a text message returns Claude Code's response
- [ ] Sending "show me the app" returns a screenshot displayed inline
- [ ] Chat works over ngrok from a phone on any network
- [ ] Existing WhatsApp/Twilio endpoints are unchanged

## Notes

- This is a dev-only tool. It can be removed or gated behind an env var before production (Phase 7).
- Once Twilio WhatsApp Sandbox is configured, WhatsApp testing resumes as planned. This does not replace WhatsApp.
- The web chat also serves as a useful demo tool for showing the product without needing a phone number.

## Review

**Status:** PASS
**Reviewed:** 2026-02-26

### Validation Results

| Criterion | Status | Evidence |
|-----------|--------|----------|
| Opening the relay URL shows the chat interface | PASS | `GET /` serves `public/index.html` via `res.sendFile()` (`server.js:59-61`). HTML is a complete 310-line single-page chat UI with header, message thread, and input bar. |
| Sending a text message returns Claude Code's response | PASS | `POST /chat` (`server.js:63-84`) calls `forwardToVM(text)` — same function used by `/sms` handler — and returns the JSON response. UI sends `fetch("/chat")` with JSON body (`index.html:271-274`). |
| Sending "show me the app" returns a screenshot inline | PASS | VM response `data.images` array rendered as `<img>` tags pointing to `/images/:filename` (`index.html:241-249`). Images served through the existing UUID-validated relay proxy (`server.js:87-111`). |
| Chat works over ngrok from any network | PASS | All URLs are relative (`/chat`, `/images/...`) — same-origin, no CORS issues. No hardcoded hosts or ports. Works through any reverse proxy. |
| Existing WhatsApp/Twilio endpoints unchanged | PASS | `git diff` confirms only additions: `path` import, `express.json()` middleware, `GET /` and `POST /chat` routes. Zero changes to `/sms` handler, `processCommand`, `sendMessage`, or VM code. VM directory has zero diff. |

### Code Quality

**Correctness:** The `/chat` endpoint is a clean, minimal adapter. It reuses `forwardToVM()` identically to the WhatsApp path, with appropriate error handling that maps HTTP status codes to meaningful error types (timeout, busy, generic error). Error responses surface partial text and images, consistent with how the WhatsApp handler surfaces partial results from failed commands.

**Security:** User-generated content rendered via `textContent` (XSS-safe). The only `innerHTML` usage is hardcoded loading dots — no user input interpolated. The `express.json()` middleware added globally doesn't interfere with Twilio's `urlencoded` payloads (different content types). No authentication on `/chat` — intentional and documented as dev-only.

**UI:** Mobile-friendly viewport meta tag, `100dvh`, touch scrolling, proper disabled states while waiting. Smart scroll behavior (auto-scrolls unless user scrolled up, resets on send). Loading indicator with elapsed-time counter. Dark theme, clean layout. 310 LOC total — no dependencies, no build step.

### Issues Found

- None blocking.

### Tech Debt

- **`GET /` route will conflict with any future landing page.** Gate behind an env var (e.g., `ENABLE_WEB_CHAT`) or move to `/chat` path before production (Phase 7).
- **No ARCHITECTURE.md or SECURITY.md update.** The web chat is a dev tool and the plan didn't call for doc updates, but `ARCHITECTURE.md` should eventually note the `/chat` endpoint for completeness.

### Next Steps

Phase complete. Next: Phase 5 (Diffs) — start with `/workflow:brainstorm` or `/workflow:plan`.
