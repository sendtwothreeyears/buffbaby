# Phase 4.2: WhatsApp Channel

**Stage:** Local Development
**Depends on:** Phase 4 (Screenshots), Phase 4.1 (Web Chat)
**Done when:** You send a WhatsApp message to the Twilio Sandbox number and receive a response on your phone via WhatsApp. SMS code and documentation are fully removed — WhatsApp is the sole channel.

## What You Build

WhatsApp as the primary (and only) messaging channel via Twilio Sandbox. This phase has three parts:

1. **WhatsApp channel addition** — Detect `whatsapp:` prefix in Twilio webhooks, route outbound with correct addressing. ~20 lines changed in `server.js`.
2. **WhatsApp-only pivot** — Remove SMS code paths, rename `/sms` → `/webhook`, make `TWILIO_WHATSAPP_NUMBER` required, bump text truncation to 4096 chars, handle WhatsApp 1-media-per-message limit.
3. **Documentation sweep** — Eliminate all SMS/MMS terminology from 26+ documentation files, rename PRD, delete superseded phase plan file.

Deliverables:
- `server.js` — WhatsApp-only relay (no SMS code, no `TWILIO_PHONE_NUMBER`, no `MAX_MMS_MEDIA`)
- `POST /webhook` endpoint (renamed from `/sms`) with `whatsapp:` prefix stripping for allowlist
- `sendMessage()` — WhatsApp-only with 1-media-per-message handling
- Text truncation bumped from 1500 → 4096 chars (WhatsApp limit)
- `TWILIO_WHATSAPP_NUMBER` required in env validation
- `.env.example` — WhatsApp Sandbox setup instructions
- `package.json` — description and keywords updated
- `ARCHITECTURE.md` — fully rewritten for WhatsApp-only
- `SECURITY.md` — WhatsApp-specific notes (24-hour session window, sandbox join code)
- `PRD_WHATSAPP_AGENTIC_COCKPIT.md` — renamed from SMS version with full rewrite
- Phase overview updated with Phase 4.2 entry
- All phase plans, brainstorms, and root docs updated to WhatsApp terminology

## Tasks

- [x] Add WhatsApp messaging channel via Twilio Sandbox
  - Plan: `docs/plans/2026-02-26-feat-whatsapp-channel-plan.md`
- [x] Pivot to WhatsApp-only — remove SMS, rename /sms to /webhook
  - Plan: `docs/plans/2026-02-26-feat-whatsapp-only-pivot-plan.md`
- [x] Documentation sweep — eliminate SMS/MMS terminology
  - Plan: `docs/plans/2026-02-26-feat-whatsapp-doc-sweep-plan.md`

## Notes

- The VM (`vm/vm-server.js`) is transport-agnostic — zero changes needed for channel switch
- `forwardToVM()` takes text, returns structured JSON — channel routing is purely at the relay boundary
- Twilio WhatsApp webhooks use the same format as SMS (form-encoded, same fields) — `whatsapp:` prefix on `From` is the only difference
- WhatsApp 24-hour session window documented as known limitation for future Phases 14/15

## Review

**Status:** PASS
**Reviewed:** 2026-02-26

### Validation Results

| Criterion | Status | Evidence |
|-----------|--------|----------|
| `TWILIO_PHONE_NUMBER` removed, `TWILIO_WHATSAPP_NUMBER` required | PASS | `server.js:8` — only `TWILIO_WHATSAPP_NUMBER` in env destructuring. `server.js:19` — in `required` array. Zero grep hits for `TWILIO_PHONE_NUMBER` in runtime code. |
| Endpoint renamed `/sms` → `/webhook` | PASS | `server.js:84` — validator URL `PUBLIC_URL + "/webhook"`. `server.js:88` — `app.post("/webhook", ...)`. `server.js:255` — startup log shows `/webhook`. Zero grep hits for `/sms` in runtime code. |
| `sendMessage()` WhatsApp-only, 1-media-per-message | PASS | `server.js:221-249` — hardcoded `from: whatsapp:${TWILIO_WHATSAPP_NUMBER}`. First image sent with text, remaining as separate media-only messages. Matches plan's proposed implementation exactly. |
| `MAX_MMS_MEDIA` constant removed | PASS | `git diff` confirms removal at line 39. No `.slice(0, MAX_MMS_MEDIA)` in media URL construction (`server.js:147`). |
| SMS-specific code paths removed | PASS | No `isWhatsApp` branching, no `TWILIO_PHONE_NUMBER` references, no MMS-specific logic. Clean WhatsApp-only code path. |
| `whatsapp:` prefix stripped for allowlist check | PASS | `server.js:90` — `from.replace(/^whatsapp:/, "")`. Allowlist stores bare E.164 numbers. Raw `from` (with prefix) used for state keying and `sendMessage()`. |
| Text truncation bumped to 4096 chars | PASS | `server.js:151` — `data.text.length > 4096`. Previously 1500. |
| WhatsApp startup log | PASS | `server.js:257` — `console.log(\`[STARTUP] WhatsApp: ${TWILIO_WHATSAPP_NUMBER}\`)` |
| `.env.example` updated | PASS | `TWILIO_PHONE_NUMBER` removed. `TWILIO_WHATSAPP_NUMBER` with sandbox setup instructions (4-step guide). Webhook URL shows `/webhook`. |
| `package.json` updated | PASS | Description: "WhatsApp relay server for textslash". Keywords: `whatsapp` added, `sms`/`mms` removed. |
| No new npm dependencies | PASS | Same 3 deps: dotenv, express, twilio. |
| `ARCHITECTURE.md` fully updated | PASS | WhatsApp-only framing throughout. Layer 1/3 describe WhatsApp. Data flow diagrams updated. 24-hour session window documented as known limitation. |
| `SECURITY.md` updated | PASS | Allowlist description notes `whatsapp:` prefix stripping. WhatsApp Sandbox limitations documented. Image proxy notes "WhatsApp media". |
| PRD renamed and rewritten | PASS | `docs/PRD_WHATSAPP_AGENTIC_COCKPIT.md` exists. Old file gone. Cross-references updated in CLAUDE.md, overview, and other files. |
| Documentation sweep — zero SMS/MMS in active docs | PASS | Verification grep returns only legitimate references: archived PRD, CHANGELOG historical entry, competitive analysis comparative context, pivot brainstorm transition context, and Twilio external URLs. All correct. |
| `PHASE_PLAN_SMS_AGENTIC_COCKPIT.md` deleted | PASS | File no longer exists. Cross-references redirected to `docs/plans/phases/00-overview.md`. |
| Web chat (`POST /chat`) regression | N/A | Web chat was on a diverged branch never merged into `feat/whatsapp-channel` (documented as tech debt in Phase 4 review). |
| WhatsApp end-to-end send/receive | MANUAL | Requires live Twilio Sandbox — cannot be validated without infrastructure. Code-level verification passes. |

### Code Quality

**Correctness:** The WhatsApp relay is clean and minimal. The diff from Phase 3's end state (`9113e90`) to HEAD shows surgical changes: env var swap, endpoint rename, prefix stripping for allowlist, WhatsApp-specific `sendMessage()`, and text truncation bump. No unnecessary code, no over-engineering. The transport-agnostic `forwardToVM()` boundary is preserved — zero VM changes for the channel switch.

**Security:** The `whatsapp:` prefix stripping is correctly scoped — stripped for allowlist check only, raw value preserved for state keying and outbound addressing. Webhook signature validation uses the renamed URL. All existing protections (UUID regex on image proxy, path traversal defense, 10MB output cap) are unchanged.

**Future-phase risks:** None identified. The WhatsApp-only architecture simplifies future phases (no dual-channel routing). The 24-hour session window limitation is correctly documented for Phases 14/15.

### Issues Found

- **(P2) Uncommitted `vm/vm-server.js` fix.** The `pendingImages` drain on the error path (P1 fix identified during Phase 4 review) is in the working tree but not committed. This fix correctly adds `images` and `text` fields to the error response (lines 140-147), making error responses consistent with timeout and success paths. Should be committed.

### Tech Debt

- **Web chat diverged branch.** Phase 4.1 (Web Chat) code lives on a branch that diverged from `9113e90` and was never merged into `feat/whatsapp-channel`. The `public/` directory is empty. If the web chat dev tool is still desired, it needs to be re-applied on this branch.
- **Manual WhatsApp testing.** End-to-end send/receive via Twilio Sandbox has not been validated as part of this review. This requires live infrastructure setup (Twilio Console webhook URL, sandbox join code, ngrok).

### Institutional Learnings Applied

- **Transport abstraction** (`docs/solutions/developer-experience/web-chat-dev-tool-twilio-bypass-20260226.md`): `forwardToVM()` is transport-agnostic — confirmed unchanged through the entire phase.
- **Stale documentation** (`docs/solutions/documentation-gaps/stale-loc-counts-links-after-refactor-20260226.md`): Grep-based verification used to audit the documentation sweep. All active docs clean.
- **Partial results pattern** (`docs/solutions/integration-issues/mms-screenshot-compression-pipeline-20260226.md`): All three exit paths (success, error, timeout) drain `pendingImages` — confirmed correct (though the error path fix is uncommitted).

### Next Steps

Phase complete. Next: **Phase 5 — Diffs** (`05-phase-diffs.md`) — start with `/workflow:brainstorm` or `/workflow:plan`.
