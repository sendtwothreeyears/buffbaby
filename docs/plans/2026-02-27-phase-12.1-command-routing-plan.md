---
title: "Phase 12.1: Command Routing + Core VM Skills + SQLite"
type: feat
status: active
date: 2026-02-27
parent: docs/plans/2026-02-27-feat-mobile-dev-cockpit-plan.md
brainstorm: docs/brainstorms/2026-02-27-mobile-dev-cockpit-brainstorm.md
---

# Phase 12.1: Command Routing + Core VM Skills + SQLite

## Overview

Users can clone repos, switch between them, check status, and get help — all via text commands from any channel. VM state survives restarts via SQLite persistence.

This is the foundation for the Mobile Dev Cockpit. Everything else (output rendering, skill discovery, polish) builds on this.

## Deployment Model

**Critical context:** One VM, one relay, one team. CWD is per-VM (not per-user). Global command queue. SQLite stores VM state.

## Architectural Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Command routing | **Hybrid** — relay handles meta-commands (help, skills), VM handles action-commands (clone, switch, repos, status), freeform → Claude Code | Keep relay thin, VM has filesystem access |
| Persistence | **SQLite** (`better-sqlite3`) on Fly volume | Single-file, no server process, atomic writes, fits single-VM model |
| Command recognition | **Exact match + pattern match** | `help`/`status`/`repos` exact. `clone <url>`/`switch <name>` pattern. Everything else → Claude Code |
| Skill reporting | **Embedded in clone/switch response** | `{ text, skills }` — relay caches for help display |

## Command Routing Flow

```
User sends message
  → Adapter → onMessage(userId, text)
    → Relay Core
      ├─ Is it approve/reject/cancel? → Handle approval flow (existing)
      ├─ Is it a relay meta-command? (help, skills)
      │    → Handle locally, respond immediately, no VM call
      ├─ Is it a VM action-command? (clone <url>, switch <name>, repos, status)
      │    → Call specific VM endpoint (POST /clone, POST /switch, GET /repos, GET /status)
      │    → clone/switch responses include skills[] → cache and update adapters
      └─ Everything else → forwardToVM() as today (Claude Code)
```

**Anti-collision rules:**
- `help me debug this` does NOT trigger help (not exact match)
- `clone the navbar` does NOT trigger clone (no URL argument)
- Discord slash commands bypass text matching entirely

## Technical Approach

### Relay Changes (`relay-core.js`)

Add `classifyCommand()` function:

```javascript
function classifyCommand(text) {
  const trimmed = text.trim();
  const lower = trimmed.toLowerCase();

  // Exact-match relay meta-commands
  if (lower === 'help' || lower === 'skills') return { type: 'meta', command: lower };

  // Exact-match VM action-commands
  if (lower === 'repos') return { type: 'action', command: 'repos' };
  if (lower === 'status') return { type: 'action', command: 'status' };

  // Pattern-match VM action-commands (require arguments)
  const cloneMatch = trimmed.match(/^clone\s+(https?:\/\/\S+)/i);
  if (cloneMatch) return { type: 'action', command: 'clone', args: { url: cloneMatch[1] } };

  const switchMatch = trimmed.match(/^switch\s+(\S+)/i);
  if (switchMatch) return { type: 'action', command: 'switch', args: { name: switchMatch[1] } };

  // Everything else → Claude Code
  return { type: 'freeform' };
}
```

Other relay changes:
- Add meta-command handlers (help, skills) — respond locally
- Add action-command forwarding to specific VM endpoints
- Add skill cache (in-memory Map, populated from clone/switch responses)
- Update `sendVMResponse` to check for `skills[]` in response and cache

### VM Changes (`vm/vm-server.js`)

New endpoints:

| Endpoint | Method | Input | Output |
|----------|--------|-------|--------|
| `/clone` | POST | `{ url }` | `{ text, skills }` — git clone to `/data/repos/<name>`, set cwd, scan skills |
| `/switch` | POST | `{ name }` | `{ text, skills }` — set cwd to `/data/repos/<name>`, scan skills |
| `/repos` | GET | — | `{ repos[] }` — list `/data/repos/*`, mark current |
| `/status` | GET | — | `{ text }` — current repo, branch, changed files |
| `/skills` | GET | — | `{ skills[] }` — cached skills for current repo |

Other VM changes:
- Initialize SQLite on startup (`better-sqlite3`)
- Store/restore cwd from `config` table
- Pass cwd to `spawn()` for Claude Code (`child_process.spawn` `cwd` option)
- Pass cwd to `collectDiffs()` and `/approve`
- Create `/data/repos/` on startup (volume mount gotcha)

### New Files

- **`vm/db.js`** — SQLite initialization, migration runner (`PRAGMA user_version`), query helpers
- **`vm/skills.js`** — scan `.claude/skills/` directory, parse skill metadata

### SQLite Schema (v1)

```sql
CREATE TABLE IF NOT EXISTS config (
  key   TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS commands (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id    TEXT NOT NULL,
  input      TEXT NOT NULL,
  output_summary TEXT,
  channel    TEXT NOT NULL,
  duration_ms INTEGER,
  created_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS skills_cache (
  repo_path  TEXT PRIMARY KEY,
  skills     TEXT NOT NULL,
  scanned_at TEXT DEFAULT (datetime('now'))
);
```

### Dockerfile Changes

Add `better-sqlite3` build dependencies:

```dockerfile
RUN apt-get update && apt-get install -y python3 make g++ && rm -rf /var/lib/apt/lists/*
```

Add `vm/db.js` and `vm/skills.js` to COPY.

### Help Output (Phase 12.1 — plain text)

```
Core Commands
  clone <url>  — Clone a repo to the VM
  switch <name> — Switch to a different repo
  repos        — List all cloned repos
  status       — Current repo, branch, changed files
  help         — Show this help
  cancel       — Cancel running command
  approve      — Approve pending changes
  reject       — Reject pending changes

Everything else is sent directly to Claude Code.
```

If project skills are cached (from a previous clone/switch):
```
Project Skills (from current repo)
  brainstorm   — Explore what to build
  plan         — Structure how to build it
  ship         — Implement + review + PR
```

## Implementation Tasks

- [x] Create `vm/db.js` — SQLite init, migrations, query helpers
- [x] Create `vm/skills.js` — skill directory scanner
- [x] Add `better-sqlite3` to `vm/package.json`, update Dockerfile
- [x] Add VM endpoints: POST `/clone`, POST `/switch`, GET `/repos`, GET `/status`, GET `/skills`
- [x] Update VM `/command` to use cwd from SQLite config
- [x] Update VM `collectDiffs()` and `/approve` to use cwd
- [x] Create `/data/repos/` on VM startup
- [x] Add `classifyCommand()` to relay-core.js
- [x] Add meta-command handlers (help, skills) in relay-core.js
- [x] Add action-command forwarding (clone, switch, repos, status → VM endpoints)
- [x] Add skill cache in relay-core.js (populate from clone/switch responses)
- [x] Existing approve/reject/cancel flow still works unchanged

## Acceptance Criteria

- [ ] `help` responds with list of core commands + any discovered project skills
- [ ] `clone <url>` clones repo to `/data/repos/<name>`, sets cwd, scans skills
- [ ] `switch <name>` changes cwd to `/data/repos/<name>`, scans skills
- [ ] `repos` lists all cloned repos with current one marked
- [ ] `status` shows current repo, branch, changed files count
- [ ] After `clone`/`switch`, subsequent Claude Code commands run in the correct cwd
- [ ] CWD survives VM restart (SQLite persistence)
- [ ] Commands from any user in the channel work (global queue)
- [ ] `help me debug this` does NOT trigger help (anti-collision)
- [ ] `clone the navbar` does NOT trigger clone (no URL argument)
- [ ] Existing approve/reject/cancel flow still works unchanged

## Dependencies

| Dependency | Notes |
|-----------|-------|
| `better-sqlite3` | Native addon, needs build tools in Dockerfile |
| `/data` volume on Fly.io | Already exists, used for images |
| `GITHUB_TOKEN` env var on VM | Already in `vm/.env.example`. Required for private repos. |

## Key References

- Relay core: `relay-core.js` (userState, onMessage, processCommand, forwardToVM)
- VM server: `vm/vm-server.js` (POST /command, collectDiffs, spawn)
- Adapter contract: `adapters/whatsapp.js`, `adapters/discord.js`, `adapters/telegram.js`
- Shared utils: `adapters/utils.js`
- Image cleanup pattern: `vm/vm-server.js:400-433` (reuse for future artifact cleanup)
- Volume mount gotcha: create dirs at startup, not in Dockerfile

## Known Gotchas

- Fly volume overlay wipes Dockerfile-created dirs → `mkdirSync` at startup
- `better-sqlite3` needs Python + make + g++ for native compilation in Docker
- Non-root user: `better-sqlite3` and new modules must work as `appuser`
- Process group kill: `git clone` must use `detached: true` + negative PID kill
- Flycast URLs must NOT include port → always use port 80
