---
title: "Phase 12.3: Project Skill Discovery + Discord Slash Commands"
type: feat
status: pending
date: 2026-02-27
parent: docs/plans/2026-02-27-feat-mobile-dev-cockpit-plan.md
depends_on: Phase 12.1
brainstorm: docs/brainstorms/2026-02-27-mobile-dev-cockpit-brainstorm.md
---

# Phase 12.3: Project Skill Discovery + Discord Slash Commands

## Overview

When users clone a repo that has `.claude/skills/`, those skills appear in help and as Discord slash commands. Skills are invoked via Claude Code (freeform), not the command router â€” the command router only discovers and *displays* them.

## Prerequisites

- Phase 12.1 complete (command routing, skill scanning infra in `vm/skills.js`, skill cache in relay)

## Technical Approach

### Skill Scanning Enhancement (`vm/skills.js`)

Phase 12.1 creates the basic `scanSkills()` function. This phase enhances it:

```javascript
function scanSkills(repoPath) {
  const skillsDir = path.join(repoPath, '.claude', 'skills');
  if (!fs.existsSync(skillsDir)) return [];

  return fs.readdirSync(skillsDir)
    .filter(f => f.endsWith('.md'))
    .map(f => {
      const content = fs.readFileSync(path.join(skillsDir, f), 'utf-8');
      const name = f.replace('.md', '').replace(/^workflow:/, '');
      const descMatch = content.match(/description:\s*"?([^"\n]+)/);
      const desc = descMatch ? descMatch[1] : name;
      return { name, description: desc, filename: f };
    });
}
```

**Trigger points:**
- After `clone` completes â†’ scan new repo
- After `switch` completes â†’ scan (check cache first)
- Cache in SQLite `skills_cache` table with `scanned_at`
- Cache TTL: 5 minutes (skills rarely change mid-session)
- Manual rescan: `skills --refresh` command

### Skills Embedded in Response

VM's `/clone` and `/switch` endpoints already return `{ text, skills }` (from Phase 12.1). The relay caches:

```javascript
if (data.skills) {
  skillCache = data.skills;
  const discordAdapter = adapters.get('discord');
  if (discordAdapter?.updateSlashCommands) {
    discordAdapter.updateSlashCommands(data.skills);
  }
}
```

### Discord Slash Command Registration

```
adapters/discord.js additions:
â”œâ”€ On startup: register core slash commands (help, status, clone, switch, repos)
â”œâ”€ updateSlashCommands(skills[]) â†’ register/deregister project-specific commands
â”œâ”€ Handle interactionCreate event (separate from messageCreate)
â”‚   â”œâ”€ Slash command â†’ extract command + options â†’ onMessage(userId, reconstructed text)
â”‚   â”œâ”€ Defer reply (>3s VM work) â†’ followUp with response
â”‚   â””â”€ Autocomplete for switch command (list repos)
â””â”€ On relay startup: reconcile â€” fetch existing commands, remove stale, add missing
```

**Rate limit awareness:** Discord allows 200 command creates/updates per day per guild. Core commands (5) + project skills (typically <20) = well within limits.

### Help Command Enhancement

Phase 12.1's plain text help gets enhanced to dynamically include project skills:

```
ðŸ“‹ Core Commands
  clone <url>  â€” Clone a repo to the VM
  switch <name> â€” Switch to a different repo
  repos        â€” List all cloned repos
  status       â€” Current repo, branch, changed files
  help         â€” Show this help
  cancel       â€” Cancel running command
  approve      â€” Approve pending changes
  reject       â€” Reject pending changes

ðŸ”§ Project Skills (from .claude/skills/ in current repo)
  brainstorm   â€” Explore what to build
  plan         â€” Structure how to build it
  ship         â€” Implement + review + PR
  ...

Everything else is sent directly to Claude Code.
```

### Relay Command Router Update

Add `skills --refresh` as a meta-command:

```javascript
if (lower === 'skills --refresh') return { type: 'meta', command: 'skills-refresh' };
```

Handler fetches `GET /skills?refresh=true` from VM, updates cache, notifies Discord adapter.

## Implementation Tasks

- [ ] Enhance `vm/skills.js` with description parsing (frontmatter + first paragraph)
- [ ] Add cache TTL logic to skill scanning (5-minute expiry in `skills_cache` table)
- [ ] Add `skills --refresh` command to relay command router
- [ ] Add `GET /skills?refresh=true` parameter support on VM
- [ ] Register core Discord slash commands on startup (help, status, clone, switch, repos)
- [ ] Add `updateSlashCommands(skills[])` to Discord adapter
- [ ] Handle `interactionCreate` event in Discord adapter
- [ ] Implement deferred reply pattern for slash commands (>3s work)
- [ ] Add autocomplete for `switch` command (list repos)
- [ ] Add startup reconciliation (remove stale slash commands)
- [ ] Enhance `help` output to include project skills section
- [ ] Update relay skill cache to notify Discord adapter on change

## Acceptance Criteria

- [ ] After `clone`, project skills from `.claude/skills/` appear in `help`
- [ ] After `switch`, skills update to reflect new repo's skills
- [ ] Discord slash commands registered for core commands on startup
- [ ] Discord slash commands dynamically updated when project skills change
- [ ] Slash commands work with deferred reply pattern (>3s VM work)
- [ ] `switch` autocomplete shows available repos in Discord
- [ ] Skills cached in SQLite, refreshed on clone/switch or every 5 minutes
- [ ] `skills --refresh` forces rescan
- [ ] Stale Discord slash commands cleaned up on relay startup

## Dependencies

| Dependency | Notes |
|-----------|-------|
| Phase 12.1 | Command routing, `vm/skills.js`, skill cache, SQLite |
| Discord `applications.commands` scope | Bot OAuth2 must include this scope |

## Key References

- Discord.js slash commands: `SlashCommandBuilder`, `REST.put(Routes.applicationGuildCommands(...))`
- Discord.js interactions: `client.on('interactionCreate', ...)`
- Existing Discord adapter: `adapters/discord.js`
- VM skills module: `vm/skills.js` (created in Phase 12.1)
- Relay skill cache: `relay-core.js` (added in Phase 12.1)

## Known Gotchas

- Discord slash commands persist on Discord's side after relay restart â†’ need reconciliation on startup
- Guild-scoped commands update instantly; global commands take up to 1 hour
- 200 command creates/updates per day per guild rate limit
- Deferred replies must be followed up within 15 minutes
