---
title: "Phase 12.2: Smart Output Rendering + Web Views"
type: feat
status: pending
date: 2026-02-27
parent: docs/plans/2026-02-27-feat-mobile-dev-cockpit-plan.md
depends_on: Phase 12.1
brainstorm: docs/brainstorms/2026-02-27-mobile-dev-cockpit-brainstorm.md
---

# Phase 12.2: Smart Output Rendering + Web Views

## Overview

Long output gets summarized in-channel with a link to a rendered web view. Short output stays inline with better formatting. 90% of the value of a full web dashboard at 10% of the effort.

## Prerequisites

- Phase 12.1 complete (command routing, SQLite, VM endpoints)
- SQLite `artifacts` table available for tracking web view files

## Technical Approach

### Output Type Detection

New module `vm/output-classifier.js`:

```javascript
function classifyOutput(text, diffs) {
  if (diffs && diffs.length > 0) return 'diff';

  if (/(\d+\s+(passed|failed|errors?|warnings?)|PASS|FAIL|✓|✗|BUILD)/i.test(text))
    return 'build';

  if (/^(import |from |const |function |class |def |export )/m.test(text))
    return 'code';

  return 'general';
}
```

### Rendering Rules

| Output Type | Short (<30 lines) | Long (>=30 lines) |
|------------|-------------------|-------------------|
| **diff** | Inline diff summary ("Changed 3 files, +45/-12") + truncated diff | Summary + "View full diff →" link |
| **code** | Inline with syntax markers | First 15 lines + "View full file →" link |
| **build** | Extract signal ("12 passed, 3 failed" + failure messages) | Signal + "View full log →" link |
| **general** | Full text inline | First ~20 lines + "View full output →" link |

### Web View System

**VM-side (`vm/web-views.js`):**

- `generateView(type, content, metadata)` → `{ id, filePath }`
  - Renders HTML from template + data
  - Writes to `/data/views/<uuid>.html`
  - Inserts into `artifacts` table with 30-min expiry
  - Returns artifact id
- HTML templates: diff, code, log, base (shared layout)
- Uses highlight.js (CDN link, no bundling)
- Mobile-first CSS: large fonts, wide tap targets, dark/light

**VM endpoint:**

```
GET /view/:id → serves /data/views/<id>.html
  - Checks artifacts table for existence + expiry
  - Returns 410 Gone with friendly "expired" page if past TTL
  - Returns 404 for unknown IDs
```

**Relay proxy:**

```
GET /view/:id → proxies to VM's GET /view/:id
  - Same UUID validation pattern as /images/:filename
  - Public URL: https://<relay-host>/view/<uuid>
```

### SQLite Schema Addition (migration v2)

```sql
CREATE TABLE IF NOT EXISTS artifacts (
  id         TEXT PRIMARY KEY,        -- UUID
  type       TEXT NOT NULL,           -- "diff" | "code" | "log" | "general"
  file_path  TEXT NOT NULL,           -- path on disk
  expires_at TEXT NOT NULL,
  created_at TEXT DEFAULT (datetime('now'))
);
```

### Adapter Changes

Each adapter's `sendVMResponse()` updated to:
1. Receive output type classification from VM response (`{ type, viewUrl }`)
2. If `viewUrl` present, append platform-appropriate link
3. Platform-specific formatting:

| Platform | Link Format | Long Output |
|----------|------------|-------------|
| **Discord** | `[View full diff →](url)` in embed | Embed with summary + link |
| **WhatsApp** | Raw URL (auto-previews) | Summary text + URL on new line |
| **Telegram** | Inline link in HTML | Summary + `<a href>` link |

### Artifact Cleanup

Extend existing 5-minute TTL cleanup (`vm/vm-server.js:400-433`) to also handle `/data/views/` using the `artifacts` table `expires_at` column.

## Implementation Tasks

- [x] Create `vm/output-classifier.js` — output type detection
- [x] Create `vm/web-views.js` — HTML generation, template rendering
- [x] Create HTML templates (diff, code, log, base layout) — mobile-first
- [x] Add `artifacts` table to SQLite schema (migration v2)
- [x] Add `GET /view/:id` endpoint to VM server
- [x] Create `/data/views/` on VM startup
- [x] Update VM `/command` response to include `outputType` and `viewUrl` for long output
- [x] Add `GET /view/:id` proxy endpoint to relay
- [x] Update WhatsApp adapter `sendVMResponse` for web view links
- [x] Update Discord adapter `sendVMResponse` for web view links
- [x] Update Telegram adapter `sendVMResponse` for web view links
- [x] Extend artifact cleanup to handle `/data/views/`

## Acceptance Criteria

- [ ] Short output (<30 lines) renders inline as today (no regression)
- [ ] Long diffs show summary + clickable link to syntax-highlighted web view
- [ ] Long code output shows first 15 lines + link to full file view
- [ ] Build/test output extracts signal (pass/fail counts, failure messages)
- [ ] Web view pages are mobile-optimized (responsive, readable on phone)
- [ ] Web view URLs expire after 30 minutes with friendly "expired" page
- [ ] Artifact cleanup runs alongside existing image cleanup
- [ ] All three adapters format links correctly for their platform

## Dependencies

| Dependency | Notes |
|-----------|-------|
| Phase 12.1 | SQLite, `/data` volume dirs |
| `highlight.js` | CDN link in HTML templates (no npm install needed) |

## Key References

- Image cleanup pattern: `vm/vm-server.js:400-433`
- Image proxy pattern: `relay-core.js:49-73`
- Adapter response formatting: each adapter's `sendVMResponse()`
- Shared utils: `adapters/utils.js` (truncateAtFileBoundary)
