# Phase 4.2: WhatsApp Pivot — Brainstorm

**Date:** 2026-02-26
**Phase:** 4.2 (WhatsApp Channel)
**Depends on:** Phase 4.1 (Web Chat Dev Tool) — PASS
**Done when:** You send a WhatsApp message to the Twilio sandbox number and receive a Claude Code response + screenshot back in WhatsApp.

## What We're Building

Add WhatsApp as the primary messaging channel using the existing Twilio WhatsApp Sandbox. The relay already handles Twilio webhooks — Twilio's WhatsApp API uses the **exact same webhook format**. The only difference is a `whatsapp:` prefix on phone numbers.

This is not a rewrite. It's routing messages through WhatsApp on the same relay.

### Why WhatsApp (Historical Analysis)

Our feasibility analysis (conducted 2026-02-26) identified critical advantages of WhatsApp over SMS for engineering workflows:

| Problem | SMS | WhatsApp |
|---------|-----|----------|
| Code diffs | Must render as PNG images | Can send as monospace text blocks for small diffs |
| Per-message cost | $0.008-0.02 per message | Free in-session (Twilio adds $0.005) |
| Media size limit | ~1MB (carrier-dependent) | 16MB |
| Rich formatting | None — plain text only | Bold, italic, monospace, code blocks |
| Real-time feedback | No typing indicators | Typing indicators between messages |
| Approval UX | User types "approve" | Tappable quick-reply buttons (future) |
| Image delivery order | Out-of-order across carriers | Reliable in-order delivery |
| Spam filtering risk | High at volume (A2P 10DLC required) | No carrier filtering |

The key insight: **WhatsApp lets us stop using images for most things.** Small diffs become monospace text. Status updates become formatted messages. Images become the exception (app screenshots, complex multi-file diffs), not the default for every visual output.

### Competitive Landscape

Four products overlap: NanoClaw/OpenClaw (WhatsApp → Claude, but general-purpose chatbots using unofficial Baileys library), Claude Code Remote Control (requires a running laptop), and Remolt (cloud IDE in browser). textslash differentiates on managed service + full Claude Code CLI + messaging-native interface with no IDE. See [`docs/brainstorms/2026-02-26-competitive-landscape.md`](2026-02-26-competitive-landscape.md) for full analysis.

## Why This Approach

### Twilio WhatsApp API (not Meta Cloud API directly)

Two options exist for WhatsApp integration:

| | Twilio WhatsApp API | Meta Cloud API (direct) |
|---|---------|-----------|
| Webhook format | **Same as SMS** (form-encoded, same fields) | Different (JSON, nested structure) |
| Code changes | ~20 lines (detect `whatsapp:` prefix) | ~150+ lines (new webhook parser, new auth) |
| Auth | Existing Twilio credentials | New Meta access tokens (expire in 24h) |
| Media handling | Same `mediaUrl` pattern as MMS | Different upload/download flow |
| Sandbox | Already available (user confirmed) | Requires Meta Developer app setup |
| Cost premium | $0.005/message over Meta direct | None |
| Risk | None — same provider | WhatsApp ban risk if Baileys; complex setup if official |

**Decision: Twilio WhatsApp API.** The $0.005/message premium is negligible at dev-tool scale (~$15/month at 100 messages/day). The code savings are massive — our entire Twilio integration works as-is.

### Twilio WhatsApp Sandbox for Testing

The WhatsApp sandbox uses **Twilio's shared sandbox number (+14155238886)**, not the user's own Twilio number. This means:

- **No Meta Business verification needed** to start testing
- **`TWILIO_WHATSAPP_NUMBER` env var needed** — the sandbox `from` number is different from `TWILIO_PHONE_NUMBER`
- Sandbox limitation: users must send a join code first (e.g., "join <word-word>") to opt in
- Sandbox webhook URL is configured separately in Twilio Console (Messaging → Try it out → WhatsApp Sandbox → "When a message comes in")
- Good enough for development and testing; production requires Meta Business verification + own number later

### WhatsApp on Same Relay

WhatsApp uses the same Twilio webhook format. The relay detects WhatsApp from the `From` field prefix:

```
POST /webhook (existing endpoint)
  └── From: "whatsapp:+15551234567" → WhatsApp channel

Hits the same forwardToVM() → same VM → same Claude Code
```

The handler:
1. Strips the `whatsapp:` prefix for allowlist check
2. Formats outbound messages for WhatsApp
3. Addresses the response with `whatsapp:` prefix for outbound

### Text-First Output Strategy (deferred)

WhatsApp supports monospace text, bold, italic, and 16MB media — meaning small diffs could be sent as formatted text instead of rendered images. **This is deferred to a follow-up phase.** Phase 4.2 ships channel routing only — WhatsApp messages go through the same image-based output path.

## End-to-End Flow

```
User sends WhatsApp message to Twilio sandbox number
  → Twilio webhook → POST /webhook (same endpoint)
  → req.body.From = "whatsapp:+15551234567"
  → Relay strips prefix, checks allowlist
  → Relay stores channel = "whatsapp" for this user
  → forwardToVM(text) — unchanged
  → VM runs Claude Code — unchanged
  → VM returns { text, images } — unchanged
  → Relay sees channel = "whatsapp"
  → Relay sends response via Twilio with to: "whatsapp:+15551234567"
  → User receives response in WhatsApp
```

## Key Decisions

| # | Decision | Rationale |
|---|----------|-----------|
| 1 | Twilio WhatsApp API, not Meta Cloud API | Same webhook format as SMS; ~20 lines changed vs ~150+ |
| 2 | Twilio sandbox for dev/testing | Already available; no Meta verification needed |
| 3 | Same `/webhook` endpoint | WhatsApp Sandbox webhook configured in Twilio Console, pointed at the existing `/webhook` endpoint |
| 4 | Detect channel from `From` field prefix | `whatsapp:+1234` vs `+1234` — Twilio's convention |
| 5 | Store channel per-user in `userState` Map | Ensures outbound replies go back on the correct channel |
| 6 | WhatsApp as primary channel | WhatsApp-only; the relay handles WhatsApp messages via Twilio |
| 7 | Same image pipeline for now | Screenshots still sent as images via WhatsApp — works fine |
| 8 | Text-first output formatting deferred | Ship channel routing first; optimize output format later |
| 9 | VM unchanged | Transport-agnostic; no changes to vm-server.js, Dockerfile, or docker-compose |

## Scope

### In Scope (Phase 4.2)

- Detect WhatsApp from `From` field prefix in webhook handler
- Strip `whatsapp:` prefix for allowlist checking
- Store channel type in per-user state (`userState` Map)
- Route outbound messages with correct `to` format (`whatsapp:+1234`)
- `sendMessage()` uses `TWILIO_WHATSAPP_NUMBER` as the `from` number
- Add `TWILIO_WHATSAPP_NUMBER` env var (sandbox: +14155238886)
- Configure WhatsApp Sandbox webhook URL in Twilio Console to point to relay's `/webhook` endpoint
- Test end-to-end: WhatsApp message → relay → VM → Claude Code → response in WhatsApp
- Test screenshots: WhatsApp message triggers screenshot → image delivered in WhatsApp
- Update `.env.example` with WhatsApp sandbox instructions
- Update ARCHITECTURE.md with WhatsApp flow

### Out of Scope

- Meta Business verification / production WhatsApp number (Phase 7+)
- Text-first output classifier (monospace diffs as text, not images) — follow-up phase
- Interactive buttons / quick replies — requires WhatsApp templates (Phase 7+)
- Typing indicators — Twilio doesn't expose this for WhatsApp sandbox
- Advanced WhatsApp formatting optimizations — deferred
- Any VM changes — vm-server.js, Dockerfile, docker-compose.yml unchanged
- Web chat changes — public/index.html unchanged

## What Changes in server.js

The changes are surgical. Here's what each function needs:

### 1. Allowlist check — strip prefix before matching

```
Current:  if (!allowlist.has(from)) { ... }
New:      const phone = from.replace(/^whatsapp:/, "");
          if (!allowlist.has(phone)) { ... }
```

### 2. Per-user state — track channel

```
Current:  userState = Map<phone, { busy, queue }>
New:      userState = Map<phone, { busy, queue, channel }>
```

Set `state.channel = channel` when a message arrives. This ensures outbound replies go back on the same channel the user messaged from.

### 3. sendMessage() — format `to` and `from` based on channel

```
Current:  params = { to, from: TWILIO_PHONE_NUMBER, body }
New:      const fromAddr = `whatsapp:${TWILIO_WHATSAPP_NUMBER}`;
          params = { to, from: fromAddr, body }
```

Note: `TWILIO_WHATSAPP_NUMBER` is the sandbox number (+14155238886).

### 4. Everything else — unchanged

- `forwardToVM()` — no changes
- `processCommand()` — no changes (pass channel through to sendMessage)
- Image proxy — no changes (WhatsApp fetches images from URLs via Twilio)
- Web chat — no changes
- Health endpoint — no changes

**Estimated diff: ~30 lines changed in server.js, plus `.env` updates.** No new files. No new dependencies.

## Twilio WhatsApp Sandbox Setup

1. In Twilio Console → Messaging → Try it out → Send a WhatsApp message
2. Note the sandbox join code (e.g., "join word-word") and sandbox number (+14155238886)
3. Set the sandbox webhook URL to your relay's `/webhook` endpoint (e.g., `https://your-ngrok-url.ngrok-free.app/webhook`)
4. Add `TWILIO_WHATSAPP_NUMBER=+14155238886` to `.env`
5. From your phone's WhatsApp, send the join code to the sandbox number to opt in
6. Once joined, any WhatsApp message to that number triggers the webhook

## Open Questions

| # | Question | Status |
|---|----------|--------|
| 1 | ~~Does the Twilio WhatsApp sandbox send webhooks to the same URL as SMS, or does it need a separate webhook URL?~~ | **Resolved:** Separate webhook URL, configured in Twilio Console under WhatsApp Sandbox settings. Must point to the same `/webhook` endpoint. |
| 2 | ~~Does Twilio's WhatsApp sandbox support media in outbound messages?~~ | **Resolved:** Twilio WhatsApp API supports media up to 16MB. Sandbox docs don't explicitly confirm media support — verify during implementation by sending a test image. |
| 3 | Should we increase the truncation limit to the 4096-char WhatsApp limit? | Defer to implementation — keep current limit for Phase 4.2, increase in text-first follow-up phase |

## What This Unlocks

Phase 4.2 is a minimal channel addition. But it sets up everything for the text-first output strategy:

- **Phase 4.3 (future):** Output classifier — detect diffs in Claude Code output, format as monospace text for WhatsApp, use images only for complex visuals
- **Phase 5 (adjusted):** Diff pipeline becomes optional — small diffs are just monospace text. Large diffs may still benefit from rendered images.
- **Phase 7+:** Meta Business verification, production WhatsApp number, interactive buttons, template messages for proactive notifications

## Prior Learnings Applied

- **NanoClaw comparison** (`docs/brainstorms/2026-02-26-nanoclaw-learnings-brainstorm.md`): NanoClaw uses Baileys (unofficial, violates WhatsApp ToS). We use Twilio's official WhatsApp API — production-grade, no ban risk. NanoClaw uses Claude Agent SDK; we use full Claude Code CLI with user's skills/workflows.
- **Phase 4 screenshots** (`docs/brainstorms/2026-02-26-phase-4-screenshots-brainstorm.md`): Image proxy pattern works for WhatsApp — Twilio fetches from the same `PUBLIC_URL/images/` endpoint.
- **Phase 3 command** (`docs/brainstorms/2026-02-26-phase-3-command-brainstorm.md`): Per-user queue, `forwardToVM()`, and `sendMessage()` are the three functions that need channel awareness. Queue logic itself is unchanged.
